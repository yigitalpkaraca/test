<!DOCTYPE html>
<html lang="tr">

<head>
    <link rel="icon" type="image/jpg" href="{{ url_for('static', filename='favicon.webp') }}">
    <meta charset="UTF-8">
    <title>Kapı Kapı</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>
    <header class="main-header">
        <div class="container nav">
            <div class="logo"> <a href="{{ url_for('home') }}" class="logo">
                    <img src="{{ url_for('static', filename='favicon.webp') }}" alt="kutu kutu logo" class="logo-img">
                </a>Kapı Kapı</div>
            <nav class="nav-right">
                <ul class="nav-links">
                    <li><a href="{{ url_for('home') }}">Ana Sayfa</a></li>
                    {% if session.get('user_name') %}
                        <li style="color: #0dbf87; font-weight: 700;">Hoş geldin, {{ session['user_name'] }}</li>
                        <li><a href="{{ url_for('profile') }}">Profilim</a></li>
                        {% if session.get('user_type') == 'kurye' %}
                            <li><a href="{{ url_for('courier') }}">Gönderi Kabul</a></li>
                        {% endif %}
                        <li><a href="{{ url_for('logout') }}" style="color: #ff7a1a;">Çıkış Yap</a></li>
                    {% else %}
                        <li><a href="{{ url_for('track') }}" class="active">Gönderi Takip</a></li>
                        <li><a href="{{ url_for('login') }}" style="color: #ff7a1a; font-weight: 600;">Giriş Yap</a></li>
                    {% endif %}
                </ul>
            </nav>
        </div>
    </header>

    <main class="page-main">
        <section class="page-header">
            <div class="container">
                <h1>Gönderi Takip</h1>
                <p>Takip numaranı girerek gönderinin durumunu görüntüleyebilirsin.</p>
            </div>
        </section>

        <section class="form-section">
            <div class="container track-layout">
                <form class="main-form" id="trackForm">
                    <div id="trackMessage"></div>
                    <label>
                        Takip Numarası
                        <input type="text" id="trackingNumber" placeholder="Örn: KT-2025-12345" required>
                    </label>
                    <button type="submit" class="btn btn-block" id="trackBtn">Durumu Göster</button>
                    <p class="form-note" id="formNote"></p>
                </form>

                <div class="status-box" id="statusBox" style="display: none;">
                    <h2>Gönderi Durumu</h2>
                    <div id="shipmentInfo" style="margin-bottom: 2rem; padding: 1.5rem; background: #f8f9fa; border-radius: 0.8rem;">
                        <!-- Gönderi bilgileri buraya gelecek -->
                    </div>
                    <div class="status-steps" id="statusSteps">
                        <!-- Durum adımları buraya gelecek -->
                    </div>
                </div>

                <div class="status-box" id="exampleBox">
                    <h2>Örnek Durum Akışı</h2>
                    <div class="status-steps">
                        <div class="status-step done">
                            <div class="dot"></div>
                            <div>
                                <h3>Gönderi Oluşturuldu</h3>
                                <p>Gönderi bilgilerin alındı.</p>
                            </div>
                        </div>
                        <div class="status-step done">
                            <div class="dot"></div>
                            <div>
                                <h3>Kurye Yolda</h3>
                                <p>Kurye, paketi teslim almak için çıkış adresine gidiyor.</p>
                            </div>
                        </div>
                        <div class="status-step current">
                            <div class="dot"></div>
                            <div>
                                <h3>Paket Yolda</h3>
                                <p>Paketin alıcı adresine doğru yolda.</p>
                            </div>
                        </div>
                        <div class="status-step">
                            <div class="dot"></div>
                            <div>
                                <h3>Teslim Edildi</h3>
                                <p>Paket alıcıya başarıyla teslim edildi.</p>
                            </div>
                        </div>
                    </div>
                    <p class="small"></p>
                </div>
            </div>
        </section>
    </main>

    <footer class="site-footer">
        <div class="footer-bottom">
            © 2025 Kapı Kapı.
        </div>
    </footer>

    <script>
        const trackForm = document.getElementById('trackForm');
        const trackingNumberInput = document.getElementById('trackingNumber');
        const trackBtn = document.getElementById('trackBtn');
        const trackMessage = document.getElementById('trackMessage');
        const statusBox = document.getElementById('statusBox');
        const exampleBox = document.getElementById('exampleBox');
        const shipmentInfo = document.getElementById('shipmentInfo');
        const statusSteps = document.getElementById('statusSteps');

        trackForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const trackingNumber = trackingNumberInput.value.trim();
            
            if (!trackingNumber) {
                showMessage('Lütfen bir takip numarası girin.', 'error');
                return;
            }

            trackBtn.disabled = true;
            trackBtn.textContent = 'Aranıyor...';

            try {
                const response = await fetch(`/api/shipments/track/${trackingNumber}`);
                const result = await response.json();

                if (result.success) {
                    displayShipment(result.shipment);
                    exampleBox.style.display = 'none';
                    statusBox.style.display = 'block';
                } else {
                    showMessage(result.message || 'Gönderi bulunamadı.', 'error');
                    statusBox.style.display = 'none';
                    exampleBox.style.display = 'block';
                }
            } catch (error) {
                console.error('Hata:', error);
                showMessage('Bir hata oluştu. Lütfen tekrar deneyin.', 'error');
            } finally {
                trackBtn.disabled = false;
                trackBtn.textContent = 'Durumu Göster';
            }
        });

        function displayShipment(shipment) {
            // Gönderi bilgilerini göster
            shipmentInfo.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                    <div>
                        <strong style="color: #666; font-size: 0.85rem;">Takip Numarası</strong>
                        <div style="font-size: 1.2rem; font-weight: 700; color: var(--orange-dark);">${shipment.tracking_number}</div>
                    </div>
                    <div>
                        <strong style="color: #666; font-size: 0.85rem;">Durum</strong>
                        <div style="font-size: 1rem; font-weight: 600; color: var(--green-dark);">${getStatusText(shipment.status)}</div>
                    </div>
                    <div>
                        <strong style="color: #666; font-size: 0.85rem;">Ücret</strong>
                        <div style="font-size: 1rem; font-weight: 600; color: var(--text);">${shipment.price}₺</div>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div>
                        <strong style="color: #666; font-size: 0.85rem;">Gönderici</strong>
                        <div>${shipment.sender_name}</div>
                        <div style="font-size: 0.9rem; color: #666;">${shipment.sender_address}</div>
                    </div>
                    <div>
                        <strong style="color: #666; font-size: 0.85rem;">Alıcı</strong>
                        <div>${shipment.receiver_name}</div>
                        <div style="font-size: 0.9rem; color: #666;">${shipment.receiver_address}</div>
                    </div>
                </div>
                ${shipment.courier_name ? `
                    <div style="margin-top: 1rem; padding: 1rem; background: #e8f5e9; border-radius: 0.5rem;">
                        <strong>Kurye:</strong> ${shipment.courier_name}
                    </div>
                ` : ''}
            `;

            // Durum adımlarını göster
            const statuses = [
                { key: 'pending', label: 'Gönderi Oluşturuldu', desc: 'Gönderi bilgilerin alındı ve kurye bekleniyor.', date: shipment.created_at },
                { key: 'accepted', label: 'Kurye Kabul Etti', desc: shipment.courier_name ? `${shipment.courier_name} gönderiyi kabul etti.` : 'Kurye gönderiyi kabul etti.', date: shipment.accepted_at },
                { key: 'in_transit', label: 'Paket Yolda', desc: 'Paketin alıcı adresine doğru yolda.', date: null },
                { key: 'delivered', label: 'Teslim Edildi', desc: 'Paket alıcıya başarıyla teslim edildi.', date: shipment.delivered_at }
            ];

            let currentStepIndex = 0;
            if (shipment.status === 'pending') currentStepIndex = 0;
            else if (shipment.status === 'accepted') currentStepIndex = 1;
            else if (shipment.status === 'delivered') currentStepIndex = 3;
            else currentStepIndex = 2;

            statusSteps.innerHTML = statuses.map((status, index) => {
                let stepClass = '';
                if (index < currentStepIndex) stepClass = 'done';
                else if (index === currentStepIndex) stepClass = 'current';
                
                return `
                    <div class="status-step ${stepClass}">
                        <div class="dot"></div>
                        <div>
                            <h3>${status.label}</h3>
                            <p>${status.desc}</p>
                            ${status.date ? `<small style="color: #999;">${new Date(status.date).toLocaleString('tr-TR')}</small>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getStatusText(status) {
            const statusMap = {
                'pending': 'Beklemede',
                'accepted': 'Kurye Kabul Etti',
                'in_transit': 'Yolda',
                'delivered': 'Teslim Edildi'
            };
            return statusMap[status] || status;
        }

        function showMessage(message, type) {
            trackMessage.innerHTML = `<div style="padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem; ${
                type === 'success' 
                    ? 'background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb;' 
                    : 'background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb;'
            }">${message}</div>`;
        }
    </script>
</body>

</html>